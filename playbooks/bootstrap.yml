- hosts: all
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  vars: # Hash512 created with: # python -c 'import crypt,getpass; print(crypt.crypt(getpass.getpass(), crypt.mksalt(crypt.METHOD_SHA512)))'
    root_password: 'hash512 password'
    anserv_password: 'hash512 password'
    emailTo: receiver@domain
    emailFrom: sender@domain
    connectTo: domain
    updateOption: minimal-security

  tasks:
    - name: Change root password
      user:
        name=root
        password={{ root_password }}

    - name: Add user anserv
      user:
        name=anserv
        password={{ anserv_password }}
        state=present

    - name: Add SSH public key to user anserv
      authorized_key:
        user=anserv
        key="{{ lookup('file', "../files/anserv.pub") }}"

    - name: Add anserv user to sudoers file
      lineinfile:
        dest: /etc/sudoers
        state: present
        line: 'anserv ALL=(ALL) NOPASSWD: ALL'
        insertafter: '# %wheel'

    - name: Disallow root SSH access
      lineinfile: dest=/etc/ssh/sshd_config
                   regexp="^PermitRootLogin"
                   line="PermitRootLogin no"
                   state=present
      notify: Restart ssh


    - name: Disallow SSH password authentication
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^PasswordAuthentication"
                  line="PasswordAuthentication no"
                  state=present
      notify: Restart ssh

    - name: Disallow SSH GSS API authentication
      lineinfile: dest=/etc/ssh/sshd_config
                  regexp="^GSSAPIAuthentication"
                  line="GSSAPIAuthentication no"
                  state=present
      notify: Restart ssh


    - name: install cronie package
      yum: name=cronie state=installed
      tags: cronie

    - name: enable cron(ie) service
      service: name=crond state=started enabled=yes
      tags: cronie

    - name: install yum-cron package
      yum: name=yum-cron state=installed
      tags: yum-cron

    - name: copy yum-cron.conf
      template: src=yum-cron.conf.j2 dest=/etc/yum/yum-cron.conf
      tags: yum-cron

    - name: enable yum-cron service
      service: name=yum-cron state=started enabled=yes
      tags: yum-cron


  handlers:

    - name: Restart ssh
      service: name=sshd state=restarted
